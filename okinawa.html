<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6å¤©5å¤œ æ²–ç¹©æµ·å³¶ä¹‹æ—… - è¡Œç¨‹èˆ‡è¨˜å¸³ (é›¢ç·šæ¨¡å¼)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Icon -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* è¨­å®šå­—é«”ç‚º Inter (ç¾ä»£ã€æ¸…æ™°)ï¼Œä¸¦åŠ å…¥ fallback ä¸­æ–‡å­—é«” */
        body {
            font-family: 'Inter', 'Noto Sans TC', 'Microsoft YaHei', sans-serif;
            background-color: #f0f9ff; /* è¼•ç›ˆçš„æ·ºè—è‰²èƒŒæ™¯ */
            padding-bottom: 7rem; /* ç‚ºäº†åº•éƒ¨çš„æµ®å‹•å°èˆªæ¬„ç•™å‡ºç©ºé–“ */
        }
        /* è—ç¶ è‰²ç³»ä¸»é¡Œé¡è‰² */
        .color-primary { background-color: #06b6d4; } /* Cyan 500 */
        .color-secondary { color: #0e7490; } /* Cyan 700 */
        .color-accent { background-color: #2dd4bf; } /* Teal 300 */

        /* å®šç¾©å¡ç‰‡æ»‘å…¥å‹•ç•« */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .itinerary-card.is-visible {
            animation: slideInUp 0.6s ease-out forwards;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            z-index: 50;
        }

        /* å°ˆé–€ç‚ºæ©Ÿå ´æ©Ÿç¥¨è¨­è¨ˆçš„æ¨£å¼ */
        .ticket-design {
            background: linear-gradient(to right, #0ea5e9, #06b6d4); /* è—è‰²åˆ°é’è‰²æ¼¸è®Š */
            position: relative;
            overflow: hidden;
        }
        .ticket-design::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 30%;
            background: rgba(255, 255, 255, 0.1);
            transform: skewX(-15deg);
        }
        .ticket-design .rip-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            border-top: 2px dashed #e0f7fa;
        }
        .ticket-design .corner-cut {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #f0f9ff; /* å¿…é ˆèˆ‡ body èƒŒæ™¯è‰²ç›¸åŒ */
        }
        .ticket-design .corner-cut.left-top { top: -10px; left: -10px; }
        .ticket-design .corner-cut.left-bottom { bottom: -10px; left: -10px; }
        .ticket-design .corner-cut.right-top { top: -10px; right: -10px; }
        .ticket-design .corner-cut.right-bottom { bottom: -10px; right: -10px; }

        /* æµ®å‹•å°èˆªæ¬„æŒ‰éˆ•æ¨£å¼ */
        .active-nav-button {
            background-color: #06b6d4; /* color-primary */
            color: white;
            box-shadow: 0 10px 15px -3px rgba(6, 182, 212, 0.5), 0 4px 6px -2px rgba(6, 182, 212, 0.05);
        }
        .inactive-nav-button {
            background-color: #f0f9ff; /* light background */
            color: #0e7490; /* color-secondary */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- é é¢æ¨™é¡Œ -->
    <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-cyan-700">ğŸï¸ æ²–ç¹©æµ·å³¶Vibeä¹‹æ—… â˜€ï¸</h1>
        <p class="text-xl text-cyan-600 mt-2">6å¤©5å¤œè¡Œç¨‹ç¸½è¦½ (06/19 - 06/24)</p>
        <!-- ç§»é™¤ Firebase ç›¸é—œçš„ç”¨æˆ¶ ID é¡¯ç¤º -->
    </header>

    <!-- è¡Œç¨‹é é¢å®¹å™¨ -->
    <div id="itinerary-page" class="">
        <!-- æ©«å¼å¤©æ•¸åˆ‡æ› (Tab Navigation) -->
        <nav class="sticky top-0 bg-white shadow-lg rounded-xl p-2 mb-8 z-30 overflow-x-auto">
            <div id="day-tabs" class="flex justify-start sm:justify-center space-x-2 sm:space-x-4 min-w-max">
                <!-- Tabs will be dynamically inserted here -->
            </div>
        </nav>

        <!-- è¡Œç¨‹å…§å®¹å€å¡Š -->
        <main id="itinerary-content" class="space-y-6">
            <!-- Itinerary cards will be dynamically inserted here -->
        </main>
    </div>

    <!-- è¨˜å¸³/é ç®—é é¢å®¹å™¨ -->
    <div id="budget-page" class="hidden p-2">

        <!-- ç¸½é ç®—é¡¯ç¤ºå€ -->
        <div class="bg-white rounded-2xl p-6 shadow-xl mb-6 border-l-4 border-cyan-500">
            <h2 class="text-2xl font-bold text-cyan-700 mb-2">ğŸ’¸ ç¸½æ”¯å‡ºæ¦‚è¦½</h2>
            <div id="total-twd" class="text-4xl font-extrabold text-cyan-800">
                NT$ 0
            </div>
            <p id="total-jpy" class="text-lg text-gray-500 mt-1">
                ç´„ Â¥ 0
            </p>
            <p class="text-xs text-gray-400 mt-2">å³æ™‚åŒ¯ç‡: 1 JPY â‰ˆ <span id="exchange-rate-display"></span> TWD</p>
        </div>

        <!-- æ–°å¢è¨˜å¸³è¡¨å–® -->
        <div class="bg-white rounded-2xl p-6 shadow-xl mb-8">
            <h3 class="text-xl font-bold text-cyan-700 mb-4 border-b pb-2">æ–°å¢ä¸€ç­†æ”¯å‡º</h3>
            <form id="add-expense-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <!-- æ—¥æœŸ -->
                    <div>
                        <label for="expense-date" class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label>
                        <input type="date" id="expense-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 p-2" required>
                    </div>
                    <!-- é‡‘é¡ -->
                    <div>
                        <label for="expense-amount" class="block text-sm font-medium text-gray-700">é‡‘é¡</label>
                        <div class="flex mt-1">
                            <input type="number" step="1" id="expense-amount" placeholder="è¼¸å…¥é‡‘é¡" class="block w-full rounded-l-lg border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 p-2" required>
                            <!-- è²¨å¹£åˆ‡æ›æŒ‰éˆ• -->
                            <button type="button" id="currency-toggle" onclick="switchCurrency()" class="px-3 rounded-r-lg bg-cyan-500 text-white font-bold hover:bg-cyan-600 transition-colors">TWD</button>
                        </div>
                    </div>
                </div>
                <!-- å‚™è¨» -->
                <div>
                    <label for="expense-description" class="block text-sm font-medium text-gray-700">å‚™è¨» (å•†å“/é …ç›®)</label>
                    <input type="text" id="expense-description" placeholder="ä¾‹å¦‚ï¼šç´€å¿µå“ã€æ™šé¤" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500 p-2" required>
                </div>
                <button type="submit" id="submit-expense-btn" class="w-full color-primary text-white font-bold py-3 rounded-lg shadow-md hover:bg-cyan-600 transition-colors">
                    <span class="material-icons align-middle mr-1">add_circle</span> æ–°å¢æ”¯å‡º
                </button>
            </form>
        </div>

        <!-- æ”¯å‡ºåˆ—è¡¨æ¨™é¡Œèˆ‡åˆªé™¤æŒ‰éˆ• -->
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-cyan-700">ğŸ“ æ”¯å‡ºæ˜ç´°</h3>
            <button id="delete-mode-button" onclick="toggleDeleteMode()" class="px-4 py-2 rounded-full text-white font-semibold transition-colors duration-200 shadow-md">
                <!-- Button text will be updated by JS -->
            </button>
        </div>
        
        <!-- æ”¯å‡ºåˆ—è¡¨ -->
        <div id="expense-list" class="space-y-3">
            <p class="text-center text-gray-500">æ­£åœ¨è¼‰å…¥æœ¬åœ°è³‡æ–™...</p>
        </div>

        <!-- åˆªé™¤ç¢ºèª Modal (åœ¨éåˆªé™¤æ¨¡å¼ä¸‹éš±è—) -->
        <div id="deletion-modal" class="fixed inset-0 hidden modal-backdrop items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all duration-300">
                <h3 class="text-xl font-bold text-red-600 mb-3">ç¢ºèªåˆªé™¤</h3>
                <p id="deletion-count" class="text-gray-700 mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤ [0] ç­†é¸å–çš„æ˜ç´°å—ï¼Ÿ</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="hideDeletionModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button onclick="confirmDeletion()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-bold">
                        ç¢ºå®šåˆªé™¤
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- æ™¯é»è©³ç´°è³‡è¨Šå½ˆå‡ºè¦–çª— (Modal) -->
    <div id="detail-modal" class="fixed inset-0 hidden modal-backdrop items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="modal-content-wrapper">
            <!-- Modal Header -->
            <div class="p-6 color-primary rounded-t-2xl flex justify-between items-center">
                <h2 id="modal-title" class="text-2xl font-bold text-white">æ™¯é»è©³ç´°è³‡è¨Š</h2>
                <button onclick="closeModal()" class="text-white hover:text-gray-200">
                    <span class="material-icons">close</span>
                </button>
            </div>

            <!-- Modal Body -->
            <div id="modal-body" class="p-6 space-y-4 text-gray-700">
                <!-- Content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- ä¸»è¦åŠŸèƒ½åˆ‡æ› (æµ®å‹•å°èˆªæ¬„) -->
    <nav id="main-nav" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white rounded-full shadow-2xl p-2 z-40 transition-all duration-300 hover:scale-105">
        <div class="flex space-x-2">
            <button id="nav-itinerary" onclick="switchMainView('itinerary')" class="nav-button active-nav-button px-6 py-3 text-lg font-bold rounded-full transition-all duration-300 flex items-center space-x-2 shadow-md hover:shadow-lg">
                <span class="material-icons text-xl">luggage</span>
                <span class="hidden sm:inline">è¡Œç¨‹</span>
            </button>
            <button id="nav-budget" onclick="switchMainView('budget')" class="nav-button inactive-nav-button px-6 py-3 text-lg font-bold rounded-full transition-all duration-300 flex items-center space-x-2 hover:shadow-lg" title="è¨˜å¸³/é ç®—è¡¨">
                <span class="material-icons text-xl">account_balance_wallet</span>
                <span class="hidden sm:inline">è¨˜å¸³</span>
            </button>
        </div>
    </nav>


    <script>
        // --- æ ¸å¿ƒè¨­å®šèˆ‡è³‡æ–™ ---

        // åŒ¯ç‡è¨­å®š (ç¤ºç¯„ç”¨)
        const JPY_TO_TWD = 0.22; // 1 æ—¥åœ“ ç´„ç­‰æ–¼ 0.22 å°å¹£
        const TWD_TO_JPY = 1 / JPY_TO_TWD;
        const LOCAL_STORAGE_KEY = 'okinawa_expenses';

        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ (ç¾åœ¨ç”± localStorage è®€å¯«)
        let expenseData = []; // å¯¦éš›æ”¯å‡ºè³‡æ–™
        let currentInputCurrency = 'TWD'; // é è¨­è¼¸å…¥è²¨å¹£ç‚ºå°å¹£
        
        // --- åˆªé™¤æ¨¡å¼ç‹€æ…‹ç®¡ç† ---
        let isDeleting = false; // æ˜¯å¦è™•æ–¼åˆªé™¤æ¨¡å¼
        let selectedExpenseIds = new Set(); // å„²å­˜è¢«é¸å–çš„æ”¯å‡º ID (æœ¬åœ° UUIDs)

        // è¡Œç¨‹è³‡æ–™ (ä¿æŒä¸è®Š)
        const itineraryData = [
            // Day 1
            { day: 1, date: '06/19 (é€±å››)', activities: [
                { time: '13:45', location: 'è‡ºç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)', type: 'airport', details: 'ä½æ–¼æ¡ƒåœ’å¸‚å¤§åœ’å€çš„æ©Ÿå ´ï¼Œè¨­æœ‰åœ–æ›¸é¤¨ã€éŠæˆ²å€ã€è³¼ç‰©å€ã€é¤å»³ä¸¦æä¾›å…è²»Wi-Fiã€‚', note: 'å ±åˆ°ã€ç™»æ©Ÿã€‚', food: 'æ©Ÿå ´ç¾é£Ÿå»£å ´' },
                { time: '18:55', location: 'é‚£éœ¸æ©Ÿå ´ (OKA)', type: 'airport', details: 'æ²–ç¹©çš„ç©ºä¸­é–€æˆ¶ï¼Œå……æ»¿åº¦å‡æ°£æ¯ã€‚', note: 'å…¥å¢ƒï¼Œæº–å‚™å‰å¾€é£¯åº—ã€‚' },
                { time: '20:25', location: 'Hotel Gran View Garden Okinawa', type: 'hotel', details: 'ä¼‘é–’é£¯åº—è¨­æœ‰ç°¡æ¨¸çš„é¤å»³ã€å®¤å¤–æ¸¸æ³³æ± å’Œå…¬å…±æ¾¡å ‚ï¼Œä¸¦æä¾›å…è²»Wi-Fiã€‚', note: 'è¾¦ç†å…¥ä½ï¼Œå¥½å¥½ä¼‘æ¯ï¼', food: 'é£¯åº—å‘¨é‚Šå°åƒ' },
            ]},
            // Day 2
            { day: 2, date: '06/20 (é€±äº”)', activities: [
                { time: '08:00', location: 'OTSè‡¨ç©ºè±å´ç‡Ÿæ¥­æ‰€(é‚£éœ¸æ©Ÿå ´)', type: 'transport', details: 'è¾¦ç†ç§Ÿè»Šæ‰‹çºŒï¼Œé–‹å§‹æ²–ç¹©è‡ªé§•ä¹‹æ—…ï¼', note: 'è¨˜å¾—æ”œå¸¶é§•ç…§æ—¥æ–‡è­¯æœ¬ã€‚', food: 'ä¾¿åˆ©å•†åº—æ—©é¤' },
                { time: '09:56', location: 'ç‰æ³‰æ´', type: 'attraction', details: 'é€™è™•é«˜è³çš„åœ°ä¸‹æ´çªŸåœ¨1967å¹´è¢«äººç™¼ç¾ï¼Œæ´ç©´å…§æœ‰è¶…éä¸€ç™¾è¬å€‹é˜ä¹³çŸ³æŸ±ï¼Œé‚„æœ‰æº¢æ»¿æ°´çš„æ± å­ã€‚', note: 'è¨˜å¾—ç©¿è‘—è¼•ä¾¿é‹å­ï¼Œæ´å…§åœ°é¢æ¿•æ»‘ã€‚', food: 'æ´ç©´æ— Blue Seal å†°æ·‡æ·‹' },
                { time: '12:48', location: 'æµœé‚Šçš„èŒ¶å±‹', type: 'food', details: 'é¢å°æµ·ç˜çš„ç»ç’ƒå±‹å’–å•¡å»³ï¼Œäº«å—ç„¡æ•µæµ·æ™¯ä¸‹åˆèŒ¶ã€‚', note: '[åƒé»å¿ƒ] æµ·æ™¯ç¬¬ä¸€æ’åº§ä½ï¼', food: 'æ‹›ç‰Œæ‰‹å·¥è›‹ç³•ã€æ²–ç¹©ç´…è‘‰èŒ¶' },
                { time: '13:56', location: 'COSTCOå¥½å¸‚å¤š æ²–ç¹©åº—', type: 'shopping', details: 'åƒ…ä¾›æœƒå“¡è³¼è²·å•†å“çš„å€‰åº«ï¼Œè²©å”®é‡è²©é›œè²¨ã€é›»å­ç”¢å“ç­‰å„ç¨®å•†å“ã€‚', note: 'è£œå……é›¶é£Ÿå’Œé£²ç”¨æ°´ã€‚', food: 'è³£å ´ç†±ç‹—ã€æŠ«è–©' },
                { time: '15:57', location: 'ç³¸æ»¿é­šå¸‚å ´', type: 'food', details: 'æ–°é®®æ¼ç²å’Œæµ·é®®æ–™ç†å¸‚å ´ï¼Œåƒ¹æ ¼å¯¦æƒ ï¼Œæ˜¯æµ·é®®æ„›å¥½è€…çš„å¤©å ‚ã€‚', note: '[åƒæ™šé¤] æ¨è–¦ç”Ÿé­šç‰‡æ‹¼ç›¤ã€‚', food: 'æ–°é®®æµ·è†½ã€é®ªé­šç”Ÿé­šç‰‡' },
                { time: '17:03', location: 'æ²–ç¹© ASHIBINAA Outlet', type: 'shopping', details: 'è¥¿é›…åœ–é€£é–å’–å•¡å»³ä½æ–¼é€™åº§å¤§å‹ Outlet ä¸­ï¼Œæä¾›è³¼ç‰©ä¼‘æ¯çš„å ´æ‰€ã€‚', note: 'é€›è¡—è³¼ç‰©ï¼Œäº«å—æŠ˜æ‰£ã€‚', food: 'Outlet å…§å„ç¨®è¼•é£Ÿ' },
                { time: '19:25', location: 'Kokusai-dori (å›½éš›é€šã‚Š)', type: 'attraction', details: 'é‚£éœ¸å¸‚æœ€ç†±é¬§çš„è¡—é“ï¼Œå……æ»¿äº†ç´€å¿µå“åº—ã€é¤å»³ã€å’Œæ™‚å°šå°åº—ã€‚', note: 'æ¡è³¼ä¼´æ‰‹ç¦®ã€‚', food: 'æš–æš®æ‹‰éºµ (åœ‹éš›é€šåº—)' },
                { time: '20:48', location: 'Hotel Gran View Garden Okinawa', type: 'hotel', details: 'è¿”å›é£¯åº—ã€‚', note: 'æº–å‚™ä¼‘æ¯ï¼Œè¿æ¥ç¬¬ä¸‰å¤©ï¼', food: 'ç„¡' },
            ]},
            // Day 3
            { day: 3, date: '06/21 (é€±å…­)', activities: [
                { time: '09:20', location: 'æ³¢ä¸Šå®®', type: 'attraction', details: 'æ²–ç¹©å…«ç¤¾ä¹‹ä¸€ï¼Œå»ºæ–¼ 1890 å¹´ï¼Œæ˜¯æ…¶å…¸çš„èˆ‰è¾¦åœ°é»ï¼Œå¯è‡ªæ‡¸å´–ä¸Šè§€è³é¢¨æ™¯ã€‚', note: 'åƒæ‹œç¥ˆç¦ï¼Œæ¬£è³å´–ä¸Šé¢¨æ™¯ã€‚', food: 'é™„è¿‘ç„¡ç‰¹åˆ¥æ¨è–¦' },
                { time: '10:58', location: 'æµœå±‹æ²–ç¹©éºµ', type: 'food', details: 'æ²–ç¹©ç•¶åœ°çŸ¥åçš„éºµåº—ï¼Œéºµæ¢ Q å½ˆï¼Œæ¹¯é ­æ¿ƒéƒã€‚', note: '[åƒåˆé¤] æ¡ç”¨è‡ªå‹•å”®ç¥¨æ©Ÿé»é¤ã€‚', food: 'æ‹›ç‰Œæ²–ç¹©éºµã€ç‚Šé£¯' },
                { time: '13:00', location: 'Orionå•¤é…’å» ', type: 'attraction', details: 'æä¾›å•¤é…’æš¢é£²å°è¦½è¡Œç¨‹ï¼ŒåŒ…æ‹¬åƒè§€é‡€è£½éç¨‹èˆ‡å“å˜—ã€‚', note: '[å·²é ç´„] 18:00 å°è¦½ï¼Œè¨˜å¾—æº–æ™‚ã€‚', food: 'å…è²»è©¦é£²æ–°é®®å•¤é…’' },
                { time: '14:11', location: 'åè­·é³³æ¢¨åœ’', type: 'attraction', details: 'ä¸»é¡Œå…¬åœ’ï¼Œé™³è¿°é€šéæ—…éŠå’Œè©¦åƒæ´»å‹•ä¾†ç™¼å±•è¾²æ¥­èˆ‡ç”Ÿæ…‹ã€‚åœ’å…§è¨­æœ‰å’–å•¡å»³å’Œç¦®å“åº—ã€‚', note: 'å“å˜—å„ç¨®é³³æ¢¨ç”¢å“ï¼Œæ­ä¹˜é³³æ¢¨è™ŸéŠåœ’ã€‚', food: 'é³³æ¢¨å†°æ·‡æ·‹ã€é³³æ¢¨æ±' },
                { time: '16:18', location: 'æ°¸æ—º åè­·åº—', type: 'shopping', details: 'å¤§å‹ç¶œåˆè¶…å¸‚ï¼Œé©åˆç•¶åœ°è³¼ç‰©å’Œè³¼è²·åœŸç‰¹ç”¢ã€‚', note: 'é»æ“Šè¼¸å…¥ç­†è¨˜ã€‚', food: 'è¶…å¸‚ç†Ÿé£Ÿå€' },
                { time: '17:33', location: 'A&W Nago', type: 'food', details: 'ç¶“å…¸ç¾å¼é€Ÿé£Ÿåº—ï¼Œä¾›æ‡‰åŒåçš„æ¼¢å ¡ã€æ¼‚æµ®é£²å“ã€è–¯æ¢ã€é›è‚‰å’Œè–¯æ¢ã€‚', note: 'å“å˜— Root Beer æ¼‚æµ®ã€‚', food: 'The Buddy Burger, Root Beer Float' },
                { time: '18:53', location: '904-0401 (æ–°ä½å®¿)', type: 'hotel', details: 'ä»Šæ™šå…¥ä½æ©ç´æ‘é™„è¿‘çš„ Airbnbã€‚', note: '[Check-in] è¨˜å¾—è·Ÿæˆ¿æ±ç¢ºèª PIN ç¢¼ã€‚', food: 'ç„¡' },
            ]},
            // Day 4
            { day: 4, date: '06/22 (é€±æ—¥)', activities: [
                { time: '08:50', location: 'æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨', type: 'attraction', details: 'ä¸–ç•Œæœ€å¤§çš„æ°´æ—é¤¨ä¹‹ä¸€ï¼Œæœ‰å·¨å¤§çš„é»‘æ½®ä¹‹æµ·ï¼Œèƒ½çœ‹åˆ°é¯¨é¯Šã€çŠç‘šã€é­šã€çˆ¬èŸ²é¡ç­‰å‹•ç‰©ã€‚', note: 'å¿…çœ‹é¯¨é¯Šé¤µé£Ÿç§€ï¼Œå»ºè­°å…ˆè²·ç¥¨ã€‚', food: 'æ°´æ—é¤¨å…§ Ocean Blue é¤å»³' },
                { time: '12:05', location: 'æŠ«è–©å–«èŒ¶ èŠ±äººé€¢', type: 'food', details: 'ä½æ–¼å±±é ‚çš„å‚³çµ±æ²–ç¹©æˆ¿å±‹ã€‚æ‰¹è–©(å¿…åƒ)åŠæ²™æ‹‰ã€‚å¯æ¬£è³æµ·æ™¯åŠè½æ—¥ç¾æ™¯ã€‚', note: '[åƒåˆé¤] ç¾éº—æµ·æ™¯é…æŠ«è–©ï¼Œäººæ°£åº—æ’éšŠéœ€æœ‰è€å¿ƒã€‚', food: 'ç‰¹è£½å››ç¨®èµ·å¸æŠ«è–©ã€æ²™æ‹‰' },
                { time: '14:42', location: 'å¤å®‡åˆ©å³¶', type: 'attraction', details: 'å¯§éœçš„å°å³¶ã€‚æœ‰æ°´æ™¯æµ·ç˜ä¸”é¢¨æ™¯å„ªç¾çš„æµ·ç˜ï¼Œé©åˆæµ®æ½›å’Œæ¸¸æ³³ã€‚ç‰¹è‰²æœ‰åçš„ã€Œè¦è¦é£¯ã€ã€‚', note: 'å°‹æ‰¾å¿ƒå½¢ç¤çŸ³ (Heart Rock)ã€‚', food: 'Kouri Shrimp (è¦è¦é£¯é¤è»Š)' },
                { time: '17:40', location: 'è¬åº§æ¯›', type: 'attraction', details: 'ç‹€ä¼¼è±¡é¼»çš„å²©æµ·å²¬çŸ³ã€‚æ·±å—éŠå®¢å’Œæ”å½±å¸«çš„å–œæ„›ã€‚', note: 'æ³¨æ„å®‰å…¨ï¼Œä¸è¦é è¿‘æ‡¸å´–é‚Šç·£ã€‚', food: 'ç„¡' },
                { time: '19:14', location: 'æ°¸æ—ºå¤¢æ¨‚åŸ æ²–ç¹©ä¾†å®¢å¤¢', type: 'shopping', details: 'æ²–ç¹©æœ€å¤§çš„è³¼ç‰©ä¸­å¿ƒä¹‹ä¸€ï¼Œæ“æœ‰åœ‹éš›å“ç‰Œå’Œå„å¼ç¾é£Ÿã€‚', note: '[åƒæ™šé¤ - é€›è¡—] æ™šé¤å¾Œå¯é€›è¡—ã€‚', food: 'ç¾é£Ÿè¡—ã€å„åœ‹æ–™ç†é¤å»³' },
                { time: '22:03', location: '904-0401 (ä½å®¿)', type: 'hotel', details: 'è¿”å›æ©ç´æ‘é™„è¿‘çš„ Airbnbã€‚', note: 'æ•´ç†æˆ°åˆ©å“ã€‚', food: 'ç„¡' },
            ]},
            // Day 5
            { day: 5, date: '06/23 (é€±ä¸€)', activities: [
                { time: '09:35', location: 'ç‰çƒæ‘', type: 'attraction', details: 'ä¾›éŠå®¢ä¼‘æ†©çš„å‚³çµ±ç‰çƒæ‘ï¼Œè¨­æœ‰é¢¨ä¿—è¡¨æ¼”ï¼Œäº¦å¯é«”é©— DIY æ‰‹ä½œåŠã€‚', note: 'è§€çœ‹å‚³çµ±å¤ªé¼“èˆè¡¨æ¼”ï¼Œé«”é©—ç‰çƒæ–‡åŒ–ã€‚', food: 'ç‰çƒæ‘å…§å°åƒ' },
                { time: '12:30', location: 'ç¾åœ‹æ‘', type: 'attraction', details: 'ç¾å¼é¢¨æ ¼çš„å¤§å‹éœ²å¤©å•†å ´ã€‚æœ‰è¨±å¤šå•†åº—å’Œé¤å»³é€²é§ï¼Œä¸¦è¨­æœ‰æ‘©å¤©è¼ªèˆ‡æµ·æ¿±å¤©è«–ã€‚', note: 'é€›è¡—è³¼ç‰©ï¼Œæ‹æ‘©å¤©è¼ªç…§ç‰‡ã€‚', food: 'A-Coop Steak Houseã€Blue Seal å†°æ·‡æ·‹' },
                { time: '14:23', location: 'SAN-Aæµ¦æ·»è¥¿æµ·å²¸ PARCO CITY', type: 'shopping', details: 'æ–°é–‹å¹•çš„å¤§å‹è³¼ç‰©ä¸­å¿ƒï¼Œä½æ–¼è¥¿æµ·å²¸ï¼Œé¢¨æ™¯å„ªç¾ã€‚', note: 'æœ€å¾Œè¡åˆºè³¼ç‰©ï¼', food: 'æµ·é‚Šæ™¯è§€é¤å»³' },
                { time: '17:37', location: 'Lacer Okinawa naha miebashi', type: 'hotel', details: 'ä»Šæ™šå…¥ä½é‚£éœ¸å¸‚å€é£¯åº—/ä½å®¿ã€‚', note: 'Check-in/ä¼‘æ¯ã€‚', food: 'ç„¡' },
                { time: '19:00', location: 'OTSè‡¨ç©ºè±å´ç‡Ÿæ¥­æ‰€ (é‚£éœ¸æ©Ÿå ´)', type: 'transport', details: 'é‚„è»Šæ‰‹çºŒï¼ŒçµæŸè‡ªé§•ã€‚', note: 'æª¢æŸ¥æ²¹ç®±æ˜¯å¦åŠ æ»¿ã€‚', food: 'ç„¡' },
                { time: '20:45', location: 'å³¶è±šå±‹', type: 'food', details: 'çŸ¥åæ²–ç¹©è±¬è‚‰æ–™ç†åº—ï¼Œä»¥é˜¿å¤è±¬èåã€‚', note: '[åƒæ™šé¤ - å·²é ç´„] 3äººï¼Œç¢ºèªè¨‚ä½ã€‚', food: 'é˜¿å¤è±¬æ¶®æ¶®é‹' },
                { time: '21:50', location: 'Lacer Okinawa naha miebashi', type: 'hotel', details: 'è¿”å›é‚£éœ¸å¸‚å€é£¯åº—/ä½å®¿ã€‚', note: 'Check-inã€‚', food: 'ç„¡' },
            ]},
            // Day 6
            { day: 6, date: '06/24 (é€±äºŒ)', activities: [
                { time: '07:03', location: 'é‚£éœ¸æ©Ÿå ´ (OKA)', type: 'airport', details: 'æº–å‚™ç™»æ©Ÿå›åœ‹ã€‚', note: 'æå‰å…©å°æ™‚æŠµé”æ©Ÿå ´ã€‚', food: 'æ©Ÿå ´æ—©é¤' },
                { time: '10:15', location: 'è‡ºç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)', type: 'airport', details: 'æŠµé”æ¡ƒåœ’æ©Ÿå ´ï¼Œæ—…ç¨‹çµæŸï¼', note: 'æœŸå¾…ä¸‹æ¬¡æ—…è¡Œï¼', food: 'ç„¡' },
            ]},
        ];

        // --- è¡Œç¨‹åŠŸèƒ½ (ä¸è®Š) ---

        /** å»ºç«‹ Google Maps å°èˆªé€£çµ */
        function getMapUrl(locationName) {
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationName + ', æ²–ç¹©')}`;
        }

        /** é¡¯ç¤ºæ™¯é»è©³ç´°è³‡è¨Š Modal */
        function openModal(activity) {
            const modal = document.getElementById('detail-modal');
            const modalWrapper = document.getElementById('modal-content-wrapper');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');

            modalTitle.textContent = activity.location;
            modalBody.innerHTML = ''; 

            let shouldShowTicket = false;
            
            if (activity.type === 'airport') {
                const isDepartureFlight = activity.location.includes('æ¡ƒåœ’') && activity.note.includes('ç™»æ©Ÿ'); 
                const isReturnFlight = activity.location.includes('é‚£éœ¸') && activity.note.includes('å›åœ‹'); 

                if (isDepartureFlight || isReturnFlight) {
                    shouldShowTicket = true;
                }
            }

            if (shouldShowTicket) {
                // æ©Ÿå ´å°ˆå±¬ - æ©Ÿç¥¨å½¢å¼è¨­è¨ˆ
                modalBody.innerHTML = `
                    <div class="ticket-design text-white p-6 rounded-lg shadow-xl relative">
                        <div class="corner-cut left-top"></div>
                        <div class="corner-cut right-top"></div>
                        <div class="corner-cut left-bottom"></div>
                        <div class="corner-cut right-bottom"></div>
                        <h3 class="text-xl font-bold mb-4 border-b border-white/30 pb-2">âœˆï¸ æ©Ÿç¥¨è©³ç´°è³‡è¨Š</h3>
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <p class="text-sm opacity-80">èˆªç­ / Flight</p>
                                <p class="text-2xl font-extrabold">${activity.location.includes('æ¡ƒåœ’') ? 'CI8350' : 'CI8351'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm opacity-80">ç™»æ©Ÿé–€ / Gate</p>
                                <p class="text-xl font-bold">A${Math.floor(Math.random() * 10) + 1}</p>
                            </div>
                        </div>
                        <div class="rip-line"></div>
                        <div class="flex justify-between mt-6 text-center">
                            <div>
                                <p class="text-sm opacity-80">å‡ºç™¼åœ° / From</p>
                                <p class="text-lg font-bold">${activity.location.includes('æ¡ƒåœ’') ? 'TPE' : 'OKA'}</p>
                            </div>
                            <div class="flex flex-col justify-center">
                                <span class="material-icons text-white/80">flight</span>
                            </div>
                            <div>
                                <p class="text-sm opacity-80">ç›®çš„åœ° / To</p>
                                <p class="text-lg font-bold">${activity.location.includes('æ¡ƒåœ’') ? 'OKA' : 'TPE'}</p>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-between">
                            <div>
                                <p class="text-sm opacity-80">é å®šæ™‚é–“ / Time</p>
                                <p class="text-lg font-bold">${activity.time}</p>
                            </div>
                            <div>
                                <p class="text-sm opacity-80">è‰™ç­‰ / Class</p>
                                <p class="text-lg font-bold">ECONOMY</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-cyan-700 border-b pb-1 mb-2">å‚™è¨»äº‹é …</h3>
                        <p>${activity.note}</p>
                    </div>
                `;
            } else {
                // ä¸€èˆ¬æ™¯é» - æ¨™æº–è³‡è¨Šé¡¯ç¤º (é©ç”¨æ–¼æ‰€æœ‰éé£›è¡Œæ´»å‹•ï¼ŒåŒ…å«æ©Ÿå ´ç´”æŠµé”/é›¢é–‹é»)
                modalBody.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-lg font-bold text-cyan-700 border-b pb-1 mb-2">ğŸŒ åœ°é»ç°¡ä»‹</h3>
                            <p>${activity.details}</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-cyan-700 border-b pb-1 mb-2">ğŸœ æ¨è–¦é™„è¿‘ç¾é£Ÿ</h3>
                            <p class="italic text-gray-500">${activity.food || 'ç„¡æ¨è–¦ç¾é£Ÿæˆ–è«‹è‡ªè¡Œæ¢ç´¢ã€‚'}</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-cyan-700 border-b pb-1 mb-2">ğŸ“ å…¶ä»–å‚™è¨»äº‹é …</h3>
                            <p class="text-red-500 font-medium">${activity.note}</p>
                        </div>
                    </div>
                `;
            }

            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex', 'opacity-100');
            setTimeout(() => {
                modalWrapper.classList.remove('scale-95', 'opacity-0');
                modalWrapper.classList.add('scale-100', 'opacity-100');
            }, 50);

        }

        /** é—œé–‰ Modal */
        function closeModal() {
            const modal = document.getElementById('detail-modal');
            const modalWrapper = document.getElementById('modal-content-wrapper');

            modalWrapper.classList.remove('scale-100', 'opacity-100');
            modalWrapper.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                modal.classList.remove('flex', 'opacity-100');
                modal.classList.add('hidden', 'opacity-0');
            }, 300);
        }

        /** æ ¹æ“šé¸å®šå¤©æ•¸æ¸²æŸ“è¡Œç¨‹å¡ç‰‡ */
        function renderItinerary(dayIndex) {
            const contentDiv = document.getElementById('itinerary-content');
            contentDiv.innerHTML = '';
            const dayData = itineraryData[dayIndex];

            dayData.activities.forEach((activity, index) => {
                const card = document.createElement('div');
                card.className = `itinerary-card bg-white p-5 sm:p-6 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 opacity-0`;
                card.style.animationDelay = `${index * 0.1}s`;

                let icon = '';
                let iconColor = 'text-cyan-500';
                switch (activity.type) {
                    case 'airport': icon = 'local_airport'; iconColor = 'text-blue-500'; break;
                    case 'hotel': icon = 'bed'; iconColor = 'text-teal-500'; break;
                    case 'food': icon = 'restaurant'; iconColor = 'text-red-400'; break;
                    case 'shopping': icon = 'shopping_bag'; iconColor = 'text-amber-500'; break;
                    case 'attraction': icon = 'nature_people'; iconColor = 'text-emerald-500'; break;
                    case 'transport': icon = 'directions_car'; iconColor = 'text-indigo-500'; break;
                    default: icon = 'place';
                }


                card.innerHTML = `
                    <div class="flex items-start justify-between">
                        <!-- å·¦å´: æ™‚é–“èˆ‡åœ°é»è³‡è¨Š -->
                        <div class="flex-1 min-w-0 pr-4 cursor-pointer" onclick="openModal(itineraryData[${dayIndex}].activities[${index}])">
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="material-icons ${iconColor} text-3xl">${icon}</span>
                                <p class="text-lg font-mono text-gray-500">${activity.time}</p>
                            </div>
                            <h3 class="text-2xl font-bold text-cyan-800 break-words">${activity.location}</h3>
                            <p class="text-sm text-gray-600 truncate mt-1">${activity.note}</p>
                        </div>

                        <!-- å³å´: åœ°åœ–èˆ‡è©³ç´°è³‡è¨ŠæŒ‰éˆ• -->
                        <div class="flex flex-col space-y-2">
                            <a href="${getMapUrl(activity.location)}" target="_blank" class="flex items-center justify-center p-3 rounded-full color-primary text-white shadow-md hover:bg-cyan-600 transition-colors" title="Google Map åœ°é»">
                                <span class="material-icons">map</span>
                            </a>
                            <button onclick="openModal(itineraryData[${dayIndex}].activities[${index}])" class="flex items-center justify-center p-3 rounded-full bg-cyan-100 text-cyan-700 shadow-md hover:bg-cyan-200 transition-colors" title="è©³ç´°è³‡è¨Š">
                                <span class="material-icons">info</span>
                            </button>
                        </div>
                    </div>
                `;
                contentDiv.appendChild(card);
            });

            setupIntersectionObserver();
        }

        /** è¨­ç½® Tab Navigation */
        function setupTabs() {
            const tabsContainer = document.getElementById('day-tabs');
            itineraryData.forEach((day, index) => {
                const button = document.createElement('button');
                button.textContent = `D${day.day} (${day.date})`; 
                button.className = `day-tab px-4 py-2 text-sm sm:text-base font-semibold rounded-full transition-all duration-200 whitespace-nowrap`;
                button.dataset.dayIndex = index;
                button.onclick = () => switchDay(index);
                tabsContainer.appendChild(button);
            });
            switchDay(0);
        }

        /** åˆ‡æ›å¤©æ•¸ */
        function switchDay(index) {
            const tabs = document.querySelectorAll('.day-tab');
            tabs.forEach(tab => {
                const isSelected = parseInt(tab.dataset.dayIndex) === index;
                if (isSelected) {
                    tab.classList.add('color-primary', 'text-white', 'shadow-md');
                    tab.classList.remove('bg-gray-100', 'text-cyan-700');
                } else {
                    tab.classList.add('bg-gray-100', 'text-cyan-700');
                    tab.classList.remove('color-primary', 'text-white', 'shadow-md');
                }
            });
            renderItinerary(index);
        }

        /** è¨­ç½®å¡ç‰‡æ»‘å…¥å‹•ç•« */
        function setupIntersectionObserver() {
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                        obs.unobserve(entry.target); 
                    }
                });
            }, {
                rootMargin: '0px',
                threshold: 0.1
            });

            document.querySelectorAll('.itinerary-card').forEach(card => {
                card.classList.remove('is-visible');
                observer.observe(card);
            });
        }


        // --- è¨˜å¸³åŠŸèƒ½ (Local Storage) ---
        
        /**
         * Local Storage: å¾æœ¬åœ°å„²å­˜è¼‰å…¥æ”¯å‡ºè³‡æ–™
         */
        function loadExpensesFromLocalStorage() {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedData) {
                    // å°‡ JSON å­—ä¸²è½‰æ›ç‚ºç‰©ä»¶é™£åˆ—
                    const parsedData = JSON.parse(storedData);
                    // ç¢ºä¿ timestamp æ¬„ä½å¯ä»¥æ’åº (æ™‚é–“è¶Šè¿‘ï¼Œtimestampå€¼è¶Šå¤§)
                    expenseData = parsedData.sort((a, b) => b.timestamp - a.timestamp);
                } else {
                    expenseData = [];
                }
            } catch (error) {
                console.error("è®€å–æœ¬åœ°å„²å­˜å¤±æ•—:", error);
                expenseData = [];
            }
            renderExpenseList(); // æ¸²æŸ“åˆ—è¡¨å’Œç¸½è¨ˆ
        }

        /**
         * Local Storage: å°‡æ”¯å‡ºè³‡æ–™å„²å­˜åˆ°æœ¬åœ°å„²å­˜
         */
        function saveExpensesToLocalStorage() {
            try {
                // å°‡ç‰©ä»¶é™£åˆ—è½‰æ›ç‚º JSON å­—ä¸²ä¸¦å„²å­˜
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(expenseData));
            } catch (error) {
                console.error("å„²å­˜åˆ°æœ¬åœ°å„²å­˜å¤±æ•—:", error);
            }
        }

        /** åˆ‡æ›è¼¸å…¥è²¨å¹£ */
        function switchCurrency() {
            const toggleButton = document.getElementById('currency-toggle');
            currentInputCurrency = currentInputCurrency === 'TWD' ? 'JPY' : 'TWD';
            toggleButton.textContent = currentInputCurrency;
        }

        /** è¨ˆç®—ç¸½é‡‘é¡ä¸¦æ›´æ–°é¡¯ç¤º */
        function calculateTotals() {
            let totalTWD = 0;

            expenseData.forEach(expense => {
                // ç¢ºä¿ amount æ˜¯æ•¸å­—
                const amount = Number(expense.amount);
                if (expense.currency === 'TWD') {
                    totalTWD += amount;
                } else if (expense.currency === 'JPY') {
                    totalTWD += amount * JPY_TO_TWD;
                }
            });

            const totalJPY = totalTWD * TWD_TO_JPY;

            document.getElementById('total-twd').textContent = `NT$ ${totalTWD.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
            document.getElementById('total-jpy').textContent = `ç´„ Â¥ ${totalJPY.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
            document.getElementById('exchange-rate-display').textContent = JPY_TO_TWD.toFixed(4);
        }

        /** æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨ */
        function renderExpenseList() {
            const listContainer = document.getElementById('expense-list');
            const deleteButton = document.getElementById('delete-mode-button');
            listContainer.innerHTML = '';

            // 1. æ›´æ–°åˆªé™¤æŒ‰éˆ•ç‹€æ…‹
            if (isDeleting) {
                deleteButton.textContent = `åˆªé™¤ (${selectedExpenseIds.size})`;
                deleteButton.classList.remove('bg-gray-400');
                deleteButton.classList.add('bg-red-500', 'hover:bg-red-600');
                deleteButton.onclick = () => {
                    if (selectedExpenseIds.size > 0) {
                        openDeletionModal(selectedExpenseIds.size);
                    } else {
                        // å¦‚æœæ²’æœ‰é¸æ“‡ä»»ä½•é …ç›®ï¼Œç›´æ¥é€€å‡ºåˆªé™¤æ¨¡å¼
                        toggleDeleteMode();
                    }
                };
            } else {
                deleteButton.innerHTML = `<span class="material-icons text-lg mr-1 align-middle">delete</span> é€²å…¥åˆªé™¤æ¨¡å¼`;
                deleteButton.classList.add('bg-gray-400', 'hover:bg-gray-500');
                deleteButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                deleteButton.onclick = toggleDeleteMode;
            }

            // 2. æ¸²æŸ“è³‡æ–™
            if (expenseData.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 p-8">å°šæœªæ–°å¢ä»»ä½•æ”¯å‡ºï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹è¨˜å¸³å§ï¼</p>';
            } else {
                expenseData.forEach(expense => {
                    const amountDisplay = expense.currency === 'JPY'
                        ? `<span class="text-xl font-semibold text-red-500">Â¥ ${Number(expense.amount).toFixed(0)}</span>`
                        : `<span class="text-xl font-semibold text-green-600">NT$ ${Number(expense.amount).toFixed(0)}</span>`;
                    
                    // ä½¿ç”¨ ISO æ ¼å¼çš„ date æ¬„ä½
                    const dateDisplay = new Date(expense.date).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
                    const isSelected = selectedExpenseIds.has(expense.id);

                    let cardClasses = 'bg-white p-4 rounded-xl shadow flex items-center justify-between transition-shadow hover:shadow-lg';
                    if (isDeleting) {
                        cardClasses += ' cursor-pointer opacity-50 transition-all duration-200';
                        if (isSelected) {
                            cardClasses = cardClasses.replace('opacity-50', 'opacity-100 ring-2 ring-red-400 bg-red-50');
                        }
                    }

                    const card = document.createElement('div');
                    card.className = cardClasses;
                    
                    if (isDeleting) {
                        // é»æ“Šå¡ç‰‡ä¾†åˆ‡æ›é¸å–ç‹€æ…‹
                        card.onclick = () => toggleSelection(expense.id);
                    }

                    card.innerHTML = `
                        <div class="flex-1 min-w-0 pr-4">
                            <p class="text-sm font-medium text-gray-500">${dateDisplay}</p>
                            <p class="text-lg font-bold text-gray-800 truncate">${expense.description}</p>
                        </div>
                        <div class="text-right flex items-center space-x-3">
                            ${amountDisplay}
                            ${isDeleting ? `<span class="material-icons text-xl ${isSelected ? 'text-red-500' : 'text-gray-300'}">${isSelected ? 'check_circle' : 'circle'}</span>` : ''}
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            }

            calculateTotals();
        }

        /** è™•ç†æ–°å¢æ”¯å‡ºè¡¨å–®æäº¤ (Local Storage Write) */
        function addExpense(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-expense-btn');

            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white inline-block mr-2"></div> å„²å­˜ä¸­...`;


            const dateInput = document.getElementById('expense-date');
            const amountInput = document.getElementById('expense-amount');
            const descriptionInput = document.getElementById('expense-description');

            const newExpenseData = {
                // ä½¿ç”¨å”¯ä¸€ IDï¼Œæ–¹ä¾¿åˆªé™¤
                id: crypto.randomUUID(), 
                date: dateInput.value,
                amount: parseFloat(amountInput.value),
                currency: currentInputCurrency,
                // ä½¿ç”¨ç•¶å‰æ™‚é–“æˆ³ä¾†æ’åº (è¶Šæ™šæ–°å¢ï¼Œå€¼è¶Šå¤§)
                timestamp: Date.now() 
            };

            if (newExpenseData.date && newExpenseData.amount > 0 && descriptionInput.value) {
                try {
                    // 1. æ–°å¢åˆ°è¨˜æ†¶é«”ä¸­çš„é™£åˆ—
                    expenseData.unshift(newExpenseData); // æ”¾åœ¨æœ€å‰é¢
                    
                    // 2. å„²å­˜åˆ° Local Storage
                    saveExpensesToLocalStorage();

                    // 3. é‡æ–°æ¸²æŸ“åˆ—è¡¨
                    renderExpenseList();

                    // 4. æ¸…ç©ºè¡¨å–®
                    amountInput.value = '';
                    descriptionInput.value = '';
                    dateInput.valueAsDate = new Date(); // é‡è¨­æ—¥æœŸç‚ºä»Šå¤©

                } catch (error) {
                    console.error("Error adding expense to local storage: ", error);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = `<span class="material-icons align-middle mr-1">add_circle</span> æ–°å¢æ”¯å‡º`;
                }
            } else {
                console.error("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ä¸¦ç¢ºä¿é‡‘é¡å¤§æ–¼é›¶");
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<span class="material-icons align-middle mr-1">add_circle</span> æ–°å¢æ”¯å‡º`;
            }
        }

        // --- åˆªé™¤åŠŸèƒ½é‚è¼¯ ---

        /** åˆ‡æ›åˆªé™¤æ¨¡å¼ */
        function toggleDeleteMode() {
            if (expenseData.length === 0 && !isDeleting) return;

            hideDeletionModal();

            isDeleting = !isDeleting;
            // é€€å‡ºåˆªé™¤æ¨¡å¼æ™‚æ¸…ç©ºé¸å–
            if (!isDeleting) {
                selectedExpenseIds.clear();
            }

            renderExpenseList();
        }

        /** è™•ç†é …ç›®é¸å– */
        function toggleSelection(id) {
            if (!isDeleting) return;

            if (selectedExpenseIds.has(id)) {
                selectedExpenseIds.delete(id);
            } else {
                selectedExpenseIds.add(id);
            }

            renderExpenseList();
        }

        /** æ‰“é–‹åˆªé™¤ç¢ºèª Modal */
        function openDeletionModal(count) {
            document.getElementById('deletion-count').textContent = `æ‚¨ç¢ºå®šè¦åˆªé™¤ [${count}] ç­†é¸å–çš„æ˜ç´°å—ï¼Ÿ`;
            const modal = document.getElementById('deletion-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        /** éš±è—åˆªé™¤ç¢ºèª Modal */
        function hideDeletionModal() {
            document.getElementById('deletion-modal').classList.add('hidden');
            document.getElementById('deletion-modal').classList.remove('flex');
        }

        /** ç¢ºèªåˆªé™¤é¸å®šçš„é …ç›® (Local Storage Delete) */
        function confirmDeletion() {
            if (selectedExpenseIds.size === 0) {
                hideDeletionModal();
                return;
            }
            
            // 1. éæ¿¾æ‰é¸å®šçš„é …ç›®
            expenseData = expenseData.filter(expense => !selectedExpenseIds.has(expense.id));
            
            // 2. å„²å­˜åˆ° Local Storage
            saveExpensesToLocalStorage();
            
            // 3. æ¸…ç©ºé¸å–ä¸¦é€€å‡ºåˆªé™¤æ¨¡å¼
            selectedExpenseIds.clear();
            toggleDeleteMode(); 
            
            hideDeletionModal();
            // renderExpenseList æœƒåœ¨ toggleDeleteMode è£¡è¢«å‘¼å«
        }

        // --- ä¸»è¦–åœ–åˆ‡æ›èˆ‡åˆå§‹åŒ– ---

        /** åˆ‡æ›ä¸»è¦–åœ– (è¡Œç¨‹æˆ–è¨˜å¸³) */
        function switchMainView(view) {
            const itineraryPage = document.getElementById('itinerary-page');
            const budgetPage = document.getElementById('budget-page');
            const navItinerary = document.getElementById('nav-itinerary');
            const navBudget = document.getElementById('nav-budget');

            if (view === 'itinerary') {
                itineraryPage.classList.remove('hidden');
                budgetPage.classList.add('hidden');
                
                navItinerary.classList.add('active-nav-button');
                navItinerary.classList.remove('inactive-nav-button');
                navBudget.classList.remove('active-nav-button');
                navBudget.classList.add('inactive-nav-button');
            } else if (view === 'budget') {
                itineraryPage.classList.add('hidden');
                budgetPage.classList.remove('hidden');

                navBudget.classList.add('active-nav-button');
                navBudget.classList.remove('inactive-nav-button');
                navItinerary.classList.remove('active-nav-button');
                navItinerary.classList.add('inactive-nav-button');

                // é€²å…¥è¨˜å¸³é é¢æ™‚ï¼Œç¢ºä¿è³‡æ–™å·²è¼‰å…¥ä¸¦æ¸²æŸ“
                isDeleting = false;
                selectedExpenseIds.clear();
                loadExpensesFromLocalStorage(); 
            }
        }


        /** åˆå§‹åŒ– */
        document.addEventListener('DOMContentLoaded', () => {
            setupTabs();
            document.getElementById('add-expense-form').addEventListener('submit', addExpense);
            document.getElementById('expense-date').valueAsDate = new Date(); // é è¨­æ—¥æœŸç‚ºä»Šå¤©

            // é—œé–‰ Modal çš„äº‹ä»¶ç›£è½
            document.getElementById('detail-modal').addEventListener('click', (e) => {
                if (e.target.id === 'detail-modal') {
                    closeModal();
                }
            });

            // é è¨­é¡¯ç¤ºè¡Œç¨‹é é¢
            switchMainView('itinerary');
        });

    </script>
</body>
</html>